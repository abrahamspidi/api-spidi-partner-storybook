import { Meta } from '@storybook/blocks';

<Meta title="API/Parada/2. Info Historica" />

## **2. Obtener información histórica de la parada** 

Este endpoint devuelve la **lista completa de enlaces (links)** asociados a una parada (`stop_id`), incluyendo **activos** y **de histórico** (pagados o expirados).

Soporta **filtros** por estado y **paginación** para manejar colecciones grandes.

Uso típico: construir tablas/consultas administrativas, reportes o vistas detalladas de todos los enlaces de una parada

## **2. Endpoint**

**GET** {{baseUrl}}/api/v1/payment-stops/{stopid}/links

## **3. Ejemplo del Request (JSON)**

Header:  
Idempotency-Key: `uuid-v4`  
GET https://api.spidi.com/api/v1/payment-stop/7f8b2c6a-4d19-45df-9a10-3e872aa812c1/links?status=pending&limit=20&offset=0

## **4. Tabla explicación de cada campo del Request**

### 4.1 Campos de nivel raíz

| Campo | Tipo | Requerido | Descripción |
| ----- | ----- | ----- | ----- |
| **spidiid** | **string (UUID)** | ✅ Sí | Identificador del comercio en SPIDI (validado contra las credenciales del request). |

### Parámetros

| Campo | Tipo dato | Requerido | Descripción de la posible transformación del origen  |
| ----- | ----- | ----- | ----- |
| **Query** `stop_id` | **string** | ✅ Sí |  Identificador único de la parada (UUID).  |
| **Query** `status` | **string** | ❌ Opcional | Filtra por estado del link. Valores: `pending`, `paid`, `expired`. Si se omite, se devuelven **todos**. |
| **Query** `from_date` | **string** | ❌ Opcional | ISO 8601 (UTC). Devuelve links **creados** desde esta fecha/hora (inclusive). |
| **Query** `to_date` | **string** | ❌ Opcional | ISO 8601 (UTC). Devuelve links **creados** hasta esta fecha/hora (inclusive). |
| **Query** `limit` | **integer** | ❌ Opcional | Máximo de elementos a devolver. Por defecto `50`. Máximo recomendado `200`. |
| **Query** `offset` | **integer** | ❌ Opcional | Desplazamiento para paginación. Por defecto `0`. |
| **Query** `sort` | **string** | ❌ Opcional | Orden. Valores sugeridos: `created_desc` (default), `created_asc`, `updated_desc`, `updated_asc`. |

### **5. Ejemplos de Response 200**

```json
{
  "success": true,
  "message": "Links retrieved successfully.",
  "data": {
    "stop_id": "7f8b2c6a-4d19-45df-9a10-3e872aa812c1",
    "total": 3,
    "limit": 20,
    "offset": 0,
    "items": [
      {
        "session_id": "21f43a2b-d9ff-42d2-87ce-559bdaf1f901",
        "status": "pending",
        "payment_url": "https://pay.spidi.com/21f43a2b-d9ff-42d2-87ce-559bdaf1f901",
        "created_at": "2025-02-15T12:30:22Z",
        "updated_at": "2025-02-15T12:31:10Z",
        "amount": 15.50,
        "currency_reference": "USD",
        "amount_ves": 1900.00,
        "bcv_exchange_rate": 122.58,
        "exchange_rate_from": "USD",
        "exchange_rate_to": "VES",
        "identifier_label": "Suscriptor",
        "identifier": "Juan Pérez",
        "description": "Mensualidad febrero",
        "due_date_link": "2025-03-01T00:00:00Z",
        "expire_behavior_link": "keep_active",
        "late_notice_message": "Tu servicio está inactivo. Paga para reactivar."
      },
      {
        "session_id": "ea1db23f-5932-49a5-a96d-08bfb14c9c34",
        "status": "paid",
        "payment_url": "https://pay.spidi.com/ea1db23f-5932-49a5-a96d-08bfb14c9c34",
        "created_at": "2025-01-30T16:55:11Z",
        "updated_at": "2025-01-30T17:05:40Z",
        "amount": 15.50,
        "currency_reference": "USD",
        "amount_ves": 1870.00,
        "bcv_exchange_rate": 120.65,
        "exchange_rate_from": "USD",
        "exchange_rate_to": "VES",
        "identifier_label": "Suscriptor",
        "identifier": "Juan Pérez",
        "description": "Mensualidad enero",
        "paid_at": "2025-01-30T17:05:33Z"
      },
      {
        "session_id": "b9d2d470-3c1e-4d3a-9b3a-8a7b0d7e3a12",
        "status": "expired",
        "payment_url": "https://pay.spidi.com/b9d2d470-3c1e-4d3a-9b3a-8a7b0d7e3a12",
        "created_at": "2025-01-10T10:10:05Z",
        "updated_at": "2025-01-10T10:20:15Z",
        "amount": 15.50,
        "currency_reference": "USD",
        "amount_ves": 1810.00,
        "bcv_exchange_rate": 116.77,
        "exchange_rate_from": "USD",
        "exchange_rate_to": "VES",
        "identifier_label": "Suscriptor",
        "identifier": "Juan Pérez",
        "description": "Mensualidad diciembre",
        "expired_at": "2025-01-10T10:20:15Z"
      }
    ]
  }
}
```

### **6. Tablas explicación de cada campo del Response 200**

### **6.1 Campos de nivel raíz (Response 200)**

| Campo | Tipo | Descripción |
| ----- | ----- | ----- |
| **success** | boolean | **Generado.** True si el endpoint se proceso de forma exitosa. False de lo contrario. |
| **message** | string | **Generado.** Mensaje de confirmación legible para humanos. |
| **data** | [objeto] | **Generado.** Lista del objeto con la información de las paradas creadas. |

### **6.2 Subtabla: Response 200 → data**

| results.x | Tipo | Descripción |
| ----- | ----- | ----- |
| **stopid** | **string/ null** | **Generado.** Identificador de la Parada SPIDI creada. |
| **total** | **integer** | Total de paradas que cumplen con los filtros aplicados. |
| **limit** | **integer** | Límite aplicado en esta página. |
| **offset** | **integer** | Offset aplicado en esta página |
| **items** | **[objeto]** | Lista de enlaces  |

### **6.3 Subtabla: Response 200 → data.items**

| results.x | Tipo | Descripción |
| ----- | ----- | ----- |
| **sessionid** | **string** | **Generado.** Identificador único de la sesión de pago creada. |
| **status** | **string** | Estado: `pending`, `paid`, `expired` |
| **paymenturl** | **string** | **Generado.** Link “URL” donde el usuario puede ser redirigido para realizar el pago, sin pasar por la parada. En caso de haber creado parada, se recomienda suministrar al pagador el **stopurl** |
| **createdat** | **string** | Fecha/hora de creación (ISO 8601). |
| **updatedat** | **string** | Última actualización (ISO 8601). |
| **currencyreference** | **string** | Moneda referencia que se usa como base para calcular el monto real en bolívares. Opciones: `"USD"`, `"EUR"`, `"COP"`. Si el monto en bolívares es fijo y no se desea indexar, se debe poner `"VES".` |
| **amount** | **number** | Monto total en la moneda indicada por currencyreference (2 decimales). |
| **amountves** | **number** | **Generado.** Monto calculado en bolívares al momento de la creación de la sesión de pago. Si la moneda referencia que se usó fue distinta a “VES”, entonces este amountves irá cambiando a medida que cambie la tasa oficial. |
| **bcvexchangerate** | **number** | **Generado.** Tasa oficial usada para la conversión a bolívares, la cual puede ser diferente a la tasa oficial del día en que se pague el enlace. |
| **exchangeratefrom** | **string** | **Generado.** Moneda base de la tasa (p. ej., "USD"). |
| **exchangerateto** | **string** | **Generado.** Moneda destino de la tasa (siempre "VES"). |
| **identifierlabel** | **string** | **Eco request.** |
| **identifier** | **string** | **Eco request.** |
| **description** | **string** | **Eco request.** |
| **duedatelink** | **string (ISO 8601)** | Fecha y hora límite (Venezuela) de vencimiento. Si se alcanza, el enlace se comportará como se elija en campo: **expirebehaviorlink** |
| **expirebehaviorlink** | **string** | Define qué le ocurre al enlace al vencer el duedatelink.  Valores posibles:  **"expire"**: el enlace queda expirado. Si hay una parada asociada, se debe generar un nuevo enlace y asociar a la parada. “**keepactive**”: el enlace sigue vigente, pero se muestra una advertencia. Esto es ideal cuando no hay penalización en costo, pero sí en servicio. |
| **latenoticemessage** | **string** | Si posterior a la fecha de vencimiento el enlace sigue activo (keepactive), se mostrará el mensaje al pagador que se defina en este campo. Ejemplo: “Tu servicio está inactivo. Realiza el pago ahora para recuperar la continuidad de tu suscripción.", |
| **paidat** | **string** | Fecha/hora de pago (solo si `status = paid`) |
| **expiredat** | **string** | Fecha/hora de expiración (solo si `status = expired`). |

### **6.4 Subtabla: Response 200 → data.linkshistory**

| results.x | Tipo | Descripción |
| ----- | ----- | ----- |
| **sessionid** | **string** | **Generado.** Identificador único de la sesión de pago creada. |
| **status** | **string** | Estado: `pending`, `paid`, `expired` |
| **currencyreference** | **string** | Moneda referencia que se usa como base para calcular el monto real en bolívares. Opciones: `"USD"`, `"EUR"`, `"COP"`. Si el monto en bolívares es fijo y no se desea indexar, se debe poner `"VES".` |
| **amount** | **number** | Monto total en la moneda indicada por currencyreference (2 decimales). |
| **amountves** | **number** | **Generado.** Monto calculado en bolívares al momento de la creación de la sesión de pago. Si la moneda referencia que se usó fue distinta a “VES”, entonces este amountves irá cambiando a medida que cambie la tasa oficial. |

### 

### 

## **7. Ejemplos de Responses diferentes de 200**

```json
{
  "success": false,
  "message": "Invalid query parameters.",
  "errors": {
    "status": "Allowed values are: pending, paid, expired.",
    "limit": "Must be an integer between 1 and 200.",
    "from_date": "Must be a valid ISO 8601 datetime."
  }
}
```

## **8. Tabla de explicación de Response con error**

### **8.1 Campos de nivel raíz (errores 4xx/5xx)**

| Campo | Tipo | Descripción |
| ----- | ----- | ----- |
| **success** | **boolean** | Siempre false en caso de error. |
| **message** | **string** | Resumen legible del error principal. |
| **errors** | **objeto | null** | Detalle por campo (opcional). |

### **8.2 Subtabla: errors (cuando exista)**

| Campo | Tipo | Descripción |
| ----- | ----- | ----- |
| **stopid** | **string** | El `stop_id` no existe o no pertenece a tus credenciales |
| **status** | **string** | Valor fuera del conjunto permitido. |
| **limit** | **string** | Límite fuera de rango o de tipo incorrecto. |
| **fromdate** | **string** | Fechas con formato inválido o rango inconsistente. |
| **todate** | **string** | Fechas con formato inválido o rango inconsistente. |

## **Buenas prácticas**

* Usa filtros (`status`, fechas) y paginación (`limit`, `offset`) para controlar el volumen de datos.

* Si tu UI necesita **solo activos**, solicita `status=pending`.

* Para conciliaciones/reporte histórico, pagina resultados y ordena por `created_desc` o `updated_desc`.
