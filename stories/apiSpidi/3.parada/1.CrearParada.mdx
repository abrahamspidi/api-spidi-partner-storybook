import { Meta } from '@storybook/blocks';

<Meta title="API/Parada/1. Crear Parada" />

## **1. Crear parada o lote de paradas**

Este endpoint permite crear una o múltiples **paradas de SPIDI** vacías en un mismo request.  
Una **parada** es un contenedor estable identificado por un `stop_id` y un `stop_url`. Su función es servir como **punto de acceso permanente**, al que posteriormente se le podrán asociar 0, 1 o N **enlaces de pago**.

Al momento de su creación, la parada no tiene enlaces activos y mostrará el estado definido por `empty_state_message`.

**Uso individual (recurrente):**  
Cuando la parada corresponde a un solo pagador (ej. un suscriptor), se convierte en el portal de pago al que siempre acudirá ese individuo. En este caso, el integrador debe garantizar que los enlaces de pago que se agreguen a la parada correspondan siempre al mismo usuario. Para facilitar esta consistencia, se utiliza el campo `internal_reference`.

**Uso grupal (puntual o recurrente):**  
Cuando la parada está destinada a varios pagadores (ej. una comunidad, amigos,  condominio), puede usarse para pagos puntuales (eventos, colectas, dividir cuenta) o recurrentes (cuotas periódicas). Los enlaces asociados podrán corresponder a múltiples personas.

Este endpoint permite crear:

1. **Una sola parada por request**, cuando se quiere crear una parada de manera puntual.

2. **Múltiples paradas en lote**, cuando se requiere registrar varias de forma simultánea (ej. una empresa de suscripciones que quiere generar el portal de pago “la parada” de todos sus clientes).

Cada parada siempre tendrá su propio `stop_id` y un `stop_url` estables, que permanecen en el tiempo aunque se agreguen o expiren enlaces de pago asociados.

## **2. Endpoint**

**POST** {{baseUrl}}/api/v1/payment-stops/batch

## **3. Ejemplo del Request (JSON)**

Header:  
Idempotency-Key: `uuid-v4`

Body:

```json
{
  "spidi_id": "a966ce0d-3af3-415d-ba86-1db5a1c21cf0",
  "continue_on_error": false,
  "items": [
    {
      "internal_reference": "8233232",
      "stop_title": "Federico Díaz",
      "empty_state_message": "No tienes pagos pendientes",
      "status": "active"
    },
    {
      "internal_reference": "8233235",
      "stop_title": "Juan González",
      "empty_state_message": "No tienes pagos pendientes",
      "status": "active"
    }
  ]
}
```

Otros ejemplos de título: Cuenta de usuario, Merienda del 15 agosto, Condominio Edificio.

## **4. Tabla explicación de cada campo del Request**

### 4.1 Campos de nivel raíz

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b>spidi_id</b></td><td><b>string (UUID)</b></td><td>✅ Sí</td><td>Identificador del comercio en SPIDI (validado contra las credenciales del request).</td></tr>
<tr><td><b>continue_on_error</b></td><td><b>boolean</b></td><td>✅ Sí</td><td>Define si se continúa con el resto de las creaciones cuando alguna falle. Default: <b><i>false</i></b></td></tr>
<tr><td><b>items</b></td><td><b>[object]</b></td><td>✅ Sí</td><td>Listado de objeto, al menos 1 ítem es necesario</td></tr>
</table>

### 4.2 Subtabla: Request → [items]

<table>
<tr><th>items.x</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b>stop_title</b></td><td><b>string</b></td><td>✅ Sí</td><td>Título visible de la parada (p. ej., "Caja Principal").</td></tr>
<tr><td><b>internal_reference</b></td><td><b>string</b></td><td>✅ Sí</td><td>Identificador interno definido por el cliente para reconciliación (no visible al usuario final). Este campo es necesario para que cada item en el batch pueda mapearse correctamente en el response. Si no tienes un identificador natural, genera un UUID o string único</td></tr>
<tr><td><b>empty_state_message</b></td><td><b>string</b></td><td>❌ Opcional</td><td>Mensaje mostrado al usuario cuando no existen enlaces activos en la parada.</td></tr>
<tr><td><b>status</b></td><td><b>string</b></td><td>❌ Opcional</td><td>Estado inicial de la parada: <b><i>"active"</i></b> (por defecto) o <b><i>"disabled"</i></b>.</td></tr>
</table>

## **5. Ejemplos de Response 200**

```json
{
  "success": true,
  "message": "Batch processed: 2 items created.",
  "batch_id": "batch_54fa7a9e-31f1-41f0-a6b9-2cd05662c721",
  "results": [
    {
      "internal_reference": "8233232",
      "success": true,
      "data": {
        "stop_id": "stp_f9317c1b-8a4f-4d7e-9f25-3a2b8b9a4f12",
        "stop_url": "https://mispidi.com/s/stp_f9317c1b-8a4f-4d7e-9f25-3a2b8b9a4f12",
        "stop_title": "Federico Díaz",
        "empty_state_message": "No tienes pagos pendientes",
        "status": "active",
        "created_at": "2025-09-27T14:15:43Z"
      }
    },
    {
      "internal_reference": "8233235",
      "success": true,
      "data": {
        "stop_id": "stp_a12f34cd-56ef-78ab-90cd-12ef34ab56cd",
        "stop_url": "https://mispidi.com/s/stp_a12f34cd-56ef-78ab-90cd-12ef34ab56cd",
        "stop_title": "Juan González",
        "empty_state_message": "No tienes pagos pendientes",
        "status": "active",
        "created_at": "2025-09-27T14:15:43Z"
      }
    }
  ]
}
```

### **6. Tablas explicación de cada campo del Response 200**

### **6.1 Campos de nivel raíz (Response 200)**

<table>
<tr><th>Campo</th><th>Tipo</th><th>Descripción</th></tr>
<tr><td><b>success</b></td><td>boolean</td><td><b>Generado.</b> True si el endpoint se proceso de forma exitosa. False de lo contrario.</td></tr>
<tr><td><b>message</b></td><td>string</td><td><b>Generado.</b> Mensaje de confirmación legible para humanos.</td></tr>
<tr><td><b>batch_id</b></td><td>string</td><td><b>Generado.</b> Identificador único del lote</td></tr>
<tr><td><b>results</b></td><td>[objeto]</td><td><b>Generado.</b> Lista del objeto con la información de las paradas creadas.</td></tr>
</table>

### **6.2 Subtabla: Response 200 → results**

<table>
<tr><th>results.x</th><th>Tipo</th><th>Descripción</th></tr>
<tr><td><b>stop_id</b></td><td><b>string/ null</b></td><td><b>Generado.</b> Identificador de la Parada SPIDI creada.</td></tr>
<tr><td><b>stop_url</b></td><td><b>string/ null</b></td><td><b>Generado.</b> URL permanente de la parada individual.</td></tr>
<tr><td><b>internal_reference</b></td><td><b>string</b></td><td><b>Eco.</b></td></tr>
<tr><td><b>stop_title</b></td><td><b>string</b></td><td><b>Eco.</b></td></tr>
<tr><td><b>empty_state_message</b></td><td><b>string</b></td><td><b>Eco.</b></td></tr>
<tr><td><b>status</b></td><td><b>string</b></td><td><b>Eco + transformado.</b> <b><i>"active"</i></b> (por defecto) o <b><i>"disabled"</i></b> según el request.</td></tr>
<tr><td><b>created_at</b></td><td><b>string</b></td><td>Fecha y hora de creación (ISO 8601).</td></tr>
</table>

### 

## **7. Ejemplos de Responses diferentes de 200**

### **7.1 400 Bad Request (campo faltante)**

```json
{
  "success": false,
  "message": "Missing required field: stop_title",
  "errors": {
    "stop_title": "This field is required."
  }
}
```

### **6.2 401/403 Unauthorized (credenciales/propiedad)**

```json
{
  "success": false,
  "message": "Unauthorized.",
  "errors": {
    "spidi_id": "The credentials are incorrect"
  }
}
```

### **6.4 422 Unprocessable Entity (tipos/valores inválidos)**

```json
{
  "success": false,
  "message": "Unprocessable entity.",
  "errors": {
    "stop_title": 2323
  }
}
```

### **6.5 500 Internal Server Error**

```json
{
  "success": false,
  "message": "Internal server error."
}
```

## **7. Tabla de explicación de cada campo de los distintos Response (errores)**

### **7.1 Campos de nivel raíz (errores 4xx/5xx)**

<table>
<tr><th>Campo</th><th>Tipo</th><th>Descripción</th></tr>
<tr><td><b>success</b></td><td><b>boolean</b></td><td>Siempre false en caso de error.</td></tr>
<tr><td><b>message</b></td><td><b>string</b></td><td>Resumen legible del error principal.</td></tr>
<tr><td><b>errors</b></td><td><b>objeto | null</b></td><td>Detalle por campo (opcional).</td></tr>
</table>

<table>
<tr><th>Aspecto</th><th><b><i>Idempotency-Key</i></b> (Header HTTP)</th><th><b><i>internal_reference</i></b> (Campo del cuerpo)</th></tr>
<tr><td><b>Propósito principal</b></td><td>Evitar duplicar solicitudes <b>idénticas</b> por error de red o reintento inmediato.</td><td>Asegurar la <b>unicidad lógica del recurso</b> (p. ej. una parada o un enlace de pago) en todo el sistema del cliente.</td></tr>
<tr><td><b>Ámbito de aplicación</b></td><td>Por <i>request</i> (a nivel transacción HTTP).</td><td>Por <i>entidad de negocio</i> (a nivel recurso).</td></tr>
<tr><td><b>Quién lo define</b></td><td>Automáticamente el cliente en cada llamada (UUID único por intento).</td><td>El integrador o sistema que consume el API, siguiendo su propia lógica (ej. número de factura, contrato, usuario, etc.).</td></tr>
<tr><td><b>Duración de validez</b></td><td>Corta: solo se recuerda durante un tiempo limitado (minutos u horas).</td><td>Larga: mantiene unicidad indefinida mientras el recurso exista.</td></tr>
<tr><td><b>Previene duplicados</b></td><td>✅ En reintentos del mismo request (mismo payload).</td><td>✅ En recreación accidental del mismo recurso lógico (ej. misma deuda).</td></tr>
<tr><td><b>Reacción ante duplicado</b></td><td>SPIDI devuelve el mismo <b><i>session_id</i></b> o <b><i>stop_id</i></b> con status 200 si el payload coincide; 409 si difiere.</td><td>SPIDI devuelve 200 o 409 según política (puede devolver el recurso existente).</td></tr>
<tr><td><b>Dónde se usa</b></td><td>Header: <b><i>Idempotency-Key: &lt;uuid-v4&gt;</i></b></td><td>Campo JSON: <b><i>"internal_reference": "INV-2025-10-USER123"</i></b></td></tr>
<tr><td><b>Visibilidad para usuarios finales</b></td><td>No se muestra, es puramente técnico.</td><td>Puede mostrarse en reportes, conciliaciones o paneles internos.</td></tr>
<tr><td><b>Ejemplo típico de uso</b></td><td>Una app de pago móvil que reintenta la creación del mismo enlace por time-out HTTP.</td><td>Un sistema de facturación que genera un enlace único por cada factura mensual.</td></tr>
</table>
