import { Meta } from '@storybook/blocks';

<Meta title="API-SPIDI/Sesion Boton de Pago/3. Crear Sesion B" />

# 1. Descripción

Este endpoint permite crear una sesión de pago a través del botón de pago en SPIDI con autenticación obligatoria e idempotencia. A diferencia de la versión anterior, incluye `settlement_id` para determinar las reglas de liquidación/split y utiliza `amount_reference` en lugar de `amount`.

**Funcionalidades principales:**
- **Autenticación obligatoria**: Requiere token Bearer válido
- **Idempotencia obligatoria**: Requiere `Idempotency-Key` en headers
- **Convención de presencia**: Los campos que no aplican no aparecen (no `null`)
- **Sin tasas en creación**: No incluye `amount_ves` ni tasas en la respuesta
- **Gestión de liquidación**: Utiliza `settlement_id` para reglas de split

# 2. Endpoint

Method: **POST**
```
"{{baseUrl}}/api/v1/payment-session/button"
```

**Headers requeridos:**
- `Authorization: Bearer <token>`
- `Content-Type: application/json`
- `Idempotency-Key: <UUIDv4>`

# 3. Ejemplo del Request

Method: **POST**
```json
{
  "settlement_id": "2432434",
  "amount_reference": 50.00,
  "currency_reference": "USD",
  "identifier_label": "Nombre del cliente",
  "identifier": "Juan Pérez",
  "description": "Pago de membresía",
  "success_url": "https://miapp.com/pago-exitoso",
  "failure_url": "https://miapp.com/pago-fallido",
  "webhook_url": "https://miapi.com/spidi/webhook"
}
```

# 4. Tabla de Parámetros del Request

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>settlement_id</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Identificador que determina las reglas de liquidación/split</td></tr>
<tr><td><b><i>amount_reference</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Monto de referencia en la moneda especificada (2 decimales)</td></tr>
<tr><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Moneda de referencia: <b><i>"USD"</i></b>, <b><i>"EUR"</i></b>, <b><i>"COP"</i></b></td></tr>
<tr><td><b><i>identifier_label</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Etiqueta descriptiva para el identificador del pagador</td></tr>
<tr><td><b><i>identifier</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Identificador único del pagador (cédula, email, etc.)</td></tr>
<tr><td><b><i>description</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Descripción del concepto de pago</td></tr>
<tr><td><b><i>success_url</i></b></td><td><b><i>string (URL)</i></b></td><td>✔ Sí</td><td>URL de redirección en caso de pago exitoso</td></tr>
<tr><td><b><i>failure_url</i></b></td><td><b><i>string (URL)</i></b></td><td>✔ Sí</td><td>URL de redirección en caso de pago fallido</td></tr>
<tr><td><b><i>webhook_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>URL para notificaciones de cambio de estado</td></tr>
</table>


# 5. Ejemplo de Response 200

```json
{
  "success": true,
  "message": "Payment session created successfully.",
  "data": {
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "session_origin": "button",
    "button_id": "btn_1024",
    "payment_url": "{{baseUrl}}/?id=3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "currency_reference": "USD",
    "amount_reference": 50.00,
    "identifier_label": "Nombre del cliente",
    "identifier": "Juan Pérez",
    "description": "Pago de membresía",
    "success_url": "https://miapp.com/pago-exitoso",
    "failure_url": "https://miapp.com/pago-fallido",
    "webhook_url": "https://miapi.com/spidi/webhook",
    "created_at": "2025-10-13T14:10:00Z"
  }
}
```

# 6. Tabla de Response 200

### Campos del Nivel Principal

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>success</i></b></td><td><b><i>boolean</i></b></td><td>✔ Sí</td><td>Indica si la operación fue exitosa</td></tr>
<tr><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Mensaje de confirmación de la creación</td></tr>
<tr><td><b><i>data</i></b></td><td><b><i>object</i></b></td><td>✔ Sí</td><td>Datos de la sesión de pago creada</td></tr>
</table>

### 6.1 Subtabla: data

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>session_id</i></b></td><td><b><i>string (UUID)</i></b></td><td>✔ Sí</td><td>Identificador único de la sesión de pago</td></tr>
<tr><td><b><i>session_origin</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Origen de la sesión: <b><i>"button"</i></b></td></tr>
<tr><td><b><i>button_id</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco del button_id enviado en el request</td></tr>
<tr><td><b><i>payment_url</i></b></td><td><b><i>string (URL)</i></b></td><td>✔ Sí</td><td>URL donde el usuario puede realizar el pago</td></tr>
<tr><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco de la moneda de referencia</td></tr>
<tr><td><b><i>amount_reference</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Eco del monto de referencia</td></tr>
<tr><td><b><i>identifier_label</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco de la etiqueta del identificador</td></tr>
<tr><td><b><i>identifier</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco del identificador del pagador</td></tr>
<tr><td><b><i>description</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco de la descripción del pago</td></tr>
<tr><td><b><i>success_url</i></b></td><td><b><i>string (URL)</i></b></td><td>✔ Sí</td><td>Eco de la URL de éxito</td></tr>
<tr><td><b><i>failure_url</i></b></td><td><b><i>string (URL)</i></b></td><td>✔ Sí</td><td>Eco de la URL de fallo</td></tr>
<tr><td><b><i>webhook_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>Eco de la URL del webhook (si se proporcionó)</td></tr>
<tr><td><b><i>created_at</i></b></td><td><b><i>string (ISO 8601)</i></b></td><td>✔ Sí</td><td>Fecha y hora de creación de la sesión</td></tr>
</table>

# 7. Ejemplos de Response ≠ 200

### Error 400 - Bad Request

```json
{
  "success": false,
  "message": "Invalid request parameters",
  "errors": {
    "settlement_id": "Settlement ID is required",
    "amount_reference": "Amount must be greater than 0"
  }
}
```

### Error 401 - Unauthorized

```json
{
  "success": false,
  "message": "Unauthorized access",
  "errors": {
    "authorization": "Invalid or missing Bearer token"
  }
}
```

### Error 422 - Unprocessable Entity

```json
{
  "success": false,
  "message": "Idempotency key already used",
  "errors": {
    "idempotency_key": "This idempotency key has already been used"
  }
}
```

# 8. Tabla de Errores

<table>
<tr><th>Código HTTP</th><th>Código de Error</th><th>Descripción</th><th>Campos de Error</th></tr>
<tr><td>400</td><td><b><i>VALIDATION_ERROR</i></b></td><td>Datos de request inválidos</td><td><b><i>field</i></b>, <b><i>message</i></b></td></tr>
<tr><td>401</td><td><b><i>UNAUTHORIZED</i></b></td><td>Token de autenticación inválido o faltante</td><td><b><i>authorization</i></b>, <b><i>message</i></b></td></tr>
<tr><td>422</td><td><b><i>IDEMPOTENCY_KEY_USED</i></b></td><td>Clave de idempotencia ya utilizada</td><td><b><i>idempotency_key</i></b>, <b><i>message</i></b></td></tr>
<tr><td>500</td><td><b><i>INTERNAL_SERVER_ERROR</i></b></td><td>Error interno del servidor</td><td><b><i>message</i></b></td></tr>
</table>
