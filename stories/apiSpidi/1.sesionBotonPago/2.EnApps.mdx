import { Meta } from '@storybook/blocks';

<Meta title="API-SPIDI/Sesion Boton de Pago/2. En Apps" />

## **Bot√≥n SPIDI para App**

El **Bot√≥n SPIDI para App** permite integrar pagos inmediatos dentro de **aplicaciones m√≥viles** (Android, iOS o frameworks h√≠bridos) mediante **deeplinks o navegaci√≥n WebView**, manteniendo la experiencia del usuario dentro del entorno de tu app.

---

### **Integraci√≥n para Aplicaciones M√≥viles**

Cuando tu app abre la p√°gina de pago de SPIDI dentro de un **WebView**, existen **dos estrategias posibles** para recuperar el control una vez que el usuario finaliza (o cancela) el pago.

---

### **Estrategia 1 ‚Äî Uso de deeplink (recomendada)**

#### **Flujo**

Tu App m√≥vil ‚Üí SPIDI (WebView) ‚Üí Redirecci√≥n autom√°tica a tu app (√©xito o fallo)

#### **Pasos**

1. El usuario hace clic en el bot√≥n de pago dentro de tu app.

2. Tu backend crea una sesi√≥n de pago con SPIDI, incluyendo:

   * `success_url`: tu deeplink de √©xito (por ejemplo, `miapp://pago-exitoso`)

   * `failure_url`: tu deeplink de error (por ejemplo, `miapp://pago-fallido`)

   * `webhook_url`: opcional, pero altamente recomendado

3. SPIDI responde con el `session_id` y el `payment_url` (`{url_base}/{session_id}`).

4. Abres el `payment_url` dentro de un **WebView moderno** (por ejemplo, WKWebView o Chrome Custom Tabs).

5. Una vez el usuario completa o cancela el pago, SPIDI redirige al `success_url` o `failure_url`, concatenando el par√°metro `session_id`:

   * `miapp://pago-exitoso?session_id=sess_abc123`

   * `miapp://pago-fallido?session_id=sess_abc123`

6. Tu app intercepta el deeplink y abre la pantalla nativa correspondiente.

7. Con el `session_id`, consulta el **endpoint de estado** para verificar el resultado (`pending`, `paid`, `failed`, `expired`).

8. Si configuraste un **webhook**, tambi√©n recibir√°s la notificaci√≥n autom√°tica en tu API.

#### **Ventajas**

* No requiere l√≥gica adicional para interceptar URLs.

* El sistema operativo detecta autom√°ticamente el esquema (`miapp://`) y abre tu app.

* Es la forma m√°s limpia y segura de retornar al flujo original.

---

### **Estrategia 2 ‚Äî Captura del cambio de URL**

#### **Flujo**

Tu App m√≥vil ‚Üí SPIDI (WebView) ‚Üí Detecci√≥n de cambio de URL ‚Üí Cierre del WebView ‚Üí Pantalla nativa (√©xito o fallo)

#### **Pasos**

1. El usuario hace clic en el bot√≥n de pago.

2. Tu backend crea una sesi√≥n de pago con SPIDI, incluyendo:

   * `webhook_url`: opcional, pero altamente recomendado.

   * `success_url` y `failure_url`: pueden dejarse vac√≠os.

3. SPIDI responde con el `session_id`.

4. Tu app construye el `payment_url` ‚Üí `{url_base}/{session_id}` y lo abre en el WebView.

5. Cuando el pago termina, la URL dentro del WebView cambia hacia una p√°gina de resultado de SPIDI.

6. Tu app debe:

   * Detectar el cambio de URL dentro del WebView.

   * Cerrar el WebView desde tu c√≥digo.

   * Mostrar la pantalla nativa correspondiente (√©xito o fallo).

7. Tu app conserva el `session_id` y consulta el **endpoint de estado** para validar el resultado.

8. Si configuraste un **webhook**, tambi√©n recibir√°s la notificaci√≥n en tu backend.

#### **Ventajas y consideraciones**

* √ötil cuando no puedes registrar un esquema personalizado.

* Requiere l√≥gica en el WebView para analizar URLs entrantes.

* Aseg√∫rate de usar componentes modernos como **WKWebView**, **Chrome Custom Tabs** o equivalentes en **React Native**, **Flutter** o **Capacitor**.

---

### **Nota t√©cnica sobre WebView**

SPIDI requiere que el WebView soporte:

* Interceptar cambios de URL.

* Ejecutar JavaScript.

* Estar actualizado con soporte de seguridad moderno.

Ejemplos recomendados:

* **iOS:** WKWebView

* **Android:** Chrome Custom Tabs

* **React Native / Flutter / Capacitor:** WebView con interceptores de URL activos

---

### **Nota estrat√©gica ‚Äî Comprobante de pago y fidelizaci√≥n**

Al consultar el estado de una sesi√≥n mediante el **endpoint de status**, SPIDI devuelve tambi√©n una **URL √∫nica del comprobante de pago**.  
 Mostrar este comprobante en tu app tiene beneficios clave:

* Mejora la **transparencia** y la **confianza del usuario**.

* En la p√°gina del comprobante, SPIDI invita al usuario a **registrarse**, lo que:

  * Facilita sus futuros pagos.

  * **Reduce las comisiones** que SPIDI le cobra a tu aplicaci√≥n.

  * Establece una relaci√≥n directa SPIDI‚Äìusuario, facilitando cobros posteriores.

üí° **Consejo:** Mostrar el comprobante desde tu app no solo mejora la experiencia del usuario, sino que tambi√©n reduce costos operativos a mediano plazo.
