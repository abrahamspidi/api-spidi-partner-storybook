import { Meta } from '@storybook/blocks';

<Meta title="Examples/Basic Integration" />

# Basic Integration Example

This guide walks you through a complete integration example with the SPIDI API, from authentication to processing payments.

## Prerequisites

Before starting, ensure you have:
- SPIDI API credentials (API key and secret)
- Node.js 16+ or Python 3.8+ installed
- Basic understanding of REST APIs

## Step 1: Authentication Setup

### JavaScript/Node.js

```javascript
// config.js
const config = {
  apiKey: process.env.SPIDI_API_KEY,
  apiSecret: process.env.SPIDI_API_SECRET,
  baseUrl: process.env.NODE_ENV === 'production' 
    ? 'https://api.spidi.com/v1' 
    : 'https://sandbox-api.spidi.com/v1',
  spidiId: process.env.SPIDI_ID
};

module.exports = config;
```

### Python

```python
# config.py
import os

class Config:
    API_KEY = os.getenv('SPIDI_API_KEY')
    API_SECRET = os.getenv('SPIDI_API_SECRET')
    BASE_URL = 'https://api.spidi.com/v1' if os.getenv('ENVIRONMENT') == 'production' else 'https://sandbox-api.spidi.com/v1'
    SPIDI_ID = os.getenv('SPIDI_ID')
```

## Step 2: Create API Client

### JavaScript/Node.js

```javascript
// spidiClient.js
const axios = require('axios');
const config = require('./config');

class SpidiClient {
  constructor() {
    this.client = axios.create({
      baseURL: config.baseUrl,
      headers: {
        'Authorization': `Bearer ${config.apiKey}`,
        'X-SPIDI-ID': config.spidiId,
        'Content-Type': 'application/json'
      }
    });

    // Add request interceptor for error handling
    this.client.interceptors.response.use(
      response => response,
      error => {
        console.error('API Error:', error.response?.data || error.message);
        throw error;
      }
    );
  }

  async createStop(stopData) {
    try {
      const response = await this.client.post('/stops', stopData);
      return response.data;
    } catch (error) {
      throw new Error(`Failed to create stop: ${error.message}`);
    }
  }

  async createPaymentSession(sessionData) {
    try {
      const response = await this.client.post('/sessions', sessionData);
      return response.data;
    } catch (error) {
      throw new Error(`Failed to create session: ${error.message}`);
    }
  }
}

module.exports = SpidiClient;
```

### Python

```python
# spidi_client.py
import requests
from config import Config

class SpidiClient:
    def __init__(self):
        self.base_url = Config.BASE_URL
        self.headers = {
            'Authorization': f'Bearer {Config.API_KEY}',
            'X-SPIDI-ID': Config.SPIDI_ID,
            'Content-Type': 'application/json'
        }

    def _make_request(self, method, endpoint, data=None):
        url = f"{self.base_url}{endpoint}"
        try:
            response = requests.request(method, url, headers=self.headers, json=data)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"API Error: {e}")
            raise

    def create_stop(self, stop_data):
        return self._make_request('POST', '/stops', stop_data)

    def create_payment_session(self, session_data):
        return self._make_request('POST', '/sessions', session_data)
```

## Step 3: Complete Integration Example

### JavaScript/Node.js

```javascript
// integration.js
const SpidiClient = require('./spidiClient');

async function completeIntegration() {
  const client = new SpidiClient();

  try {
    // Step 1: Create a stop
    console.log('Creating stop...');
    const stopData = {
      spidi_id: process.env.SPIDI_ID,
      continue_on_error: false,
      items: [
        {
          internal_reference: `stop_${Date.now()}`,
          stop_title: 'Test Payment Stop',
          empty_state_message: 'No pending payments',
          status: 'active'
        }
      ]
    };

    const stopResult = await client.createStop(stopData);
    console.log('Stop created:', stopResult);

    // Step 2: Create a payment session
    console.log('Creating payment session...');
    const sessionData = {
      amount: 50.00,
      currency: 'USD',
      description: 'Test payment',
      return_url: 'https://yourapp.com/success',
      cancel_url: 'https://yourapp.com/cancel',
      stop_id: stopResult.data.created_stops[0].id
    };

    const sessionResult = await client.createPaymentSession(sessionData);
    console.log('Session created:', sessionResult);

    // Step 3: Handle the payment URL
    console.log('Payment URL:', sessionResult.data.payment_url);

  } catch (error) {
    console.error('Integration failed:', error.message);
  }
}

// Run the integration
completeIntegration();
```

### Python

```python
# integration.py
from spidi_client import SpidiClient
import time

def complete_integration():
    client = SpidiClient()

    try:
        # Step 1: Create a stop
        print('Creating stop...')
        stop_data = {
            'spidi_id': Config.SPIDI_ID,
            'continue_on_error': False,
            'items': [
                {
                    'internal_reference': f'stop_{int(time.time())}',
                    'stop_title': 'Test Payment Stop',
                    'empty_state_message': 'No pending payments',
                    'status': 'active'
                }
            ]
        }

        stop_result = client.create_stop(stop_data)
        print('Stop created:', stop_result)

        # Step 2: Create a payment session
        print('Creating payment session...')
        session_data = {
            'amount': 50.00,
            'currency': 'USD',
            'description': 'Test payment',
            'return_url': 'https://yourapp.com/success',
            'cancel_url': 'https://yourapp.com/cancel',
            'stop_id': stop_result['data']['created_stops'][0]['id']
        }

        session_result = client.create_payment_session(session_data)
        print('Session created:', session_result)

        # Step 3: Handle the payment URL
        print('Payment URL:', session_result['data']['payment_url'])

    except Exception as error:
        print(f'Integration failed: {error}')

# Run the integration
if __name__ == '__main__':
    complete_integration()
```

## Step 4: Environment Setup

Create a `.env` file with your credentials:

```env
# .env
SPIDI_API_KEY=your_api_key_here
SPIDI_API_SECRET=your_api_secret_here
SPIDI_ID=your_spidi_id_here
ENVIRONMENT=sandbox
```

## Step 5: Error Handling

### JavaScript/Node.js

```javascript
// errorHandler.js
function handleApiError(error) {
  if (error.response) {
    // Server responded with error status
    const { status, data } = error.response;
    
    switch (status) {
      case 400:
        console.error('Bad Request:', data.message);
        break;
      case 401:
        console.error('Unauthorized: Check your API credentials');
        break;
      case 429:
        console.error('Rate Limited: Too many requests');
        break;
      case 500:
        console.error('Server Error: Please try again later');
        break;
      default:
        console.error('API Error:', data.message);
    }
  } else if (error.request) {
    // Network error
    console.error('Network Error: Unable to reach SPIDI API');
  } else {
    // Other error
    console.error('Error:', error.message);
  }
}
```

### Python

```python
# error_handler.py
def handle_api_error(error):
    if hasattr(error, 'response') and error.response is not None:
        # Server responded with error status
        status = error.response.status_code
        data = error.response.json()
        
        if status == 400:
            print(f'Bad Request: {data.get("message", "Invalid request")}')
        elif status == 401:
            print('Unauthorized: Check your API credentials')
        elif status == 429:
            print('Rate Limited: Too many requests')
        elif status == 500:
            print('Server Error: Please try again later')
        else:
            print(f'API Error: {data.get("message", "Unknown error")}')
    else:
        # Network or other error
        print(f'Error: {error}')
```

## Testing Your Integration

1. **Start with Sandbox**: Always test in sandbox environment first
2. **Use Test Cards**: Use SPIDI's test card numbers for payment testing
3. **Monitor Logs**: Check both success and error scenarios
4. **Validate Webhooks**: Ensure your webhook endpoints are working

## Next Steps

- [Advanced Integration](./AdvancedIntegration) - More complex integration patterns
- [Webhook Handling](./WebhookHandling) - Setting up webhook endpoints
- [Error Recovery](./ErrorRecovery) - Handling and recovering from errors
- [Production Deployment](./ProductionDeployment) - Moving to production

## Support

If you encounter issues:
1. Check the [API Reference](../api/authentication/GettingStarted)
2. Review [Common Errors](../api/errors/CommonErrors)
3. Contact SPIDI support with your integration details
