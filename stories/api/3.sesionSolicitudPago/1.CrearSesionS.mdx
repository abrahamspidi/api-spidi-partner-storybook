import { Meta } from '@storybook/blocks';

<Meta title="API/Sesion Solicitud de Pago/1. Crear Sesion S" />

## Crear Sesion de Solicitud de Pago

# 1. Descripción

Este endpoint permite **crear múltiples solicitudes de pago** (1..N) en un mismo request, con idempotencia y resultados por ítem.

Cada enlace nace en estado **`pending`** y el mismo payment_url sirve para reintentar mientras no expire. Contiene sus montos de referencia, además de metadatos visibles (identificador, descripción) y de control (deeplinks/URLs y webhook).

# 2. Endpoint

Method: **POST**
```
{{baseUrl}}/api/v1/payment-session/request/batch
```

**Headers requeridos:**
- `Authorization: Bearer {token}`
- `Content-Type: application/json`
- `Idempotency-Key: {unique_key}`

# 3. Ejemplo del Request

Method: **POST**
```json
{
  "continue_on_error": false,
  "items": [
    {
      "internal_reference": "INV-2025-10-USER_0001",
      "amount": 15.50,
      "currency_reference": "USD",
      "identifier_label": "Suscriptor",
      "identifier": "Ana Pérez",
      "description": "Suscripción Premium — Octubre",
      "due_date_link": "2025-10-31T23:59:59Z",
      "expire_behavior_link": "keep_active",
      "late_notice_message": "Tu servicio está inactivo. Paga para reactivar.",
      "success_url": "miapp://pago/exitoso",
      "failure_url": "miapp://pago/cancelado",
      "webhook_url": "https://miapi.com/spidi/webhook"
    },
    {
      "internal_reference": "INV-2025-10-USER_0002",
      "amount": 12.00,
      "currency_reference": "USD",
      "identifier_label": "Suscriptor",
      "identifier": "Luis Gómez",
      "description": "Suscripción Básica — Octubre",
      "due_date_link": "2025-10-31T23:59:59Z",
      "expire_behavior_link": "expire",
      "success_url": "miapp://pago/exitoso",
      "failure_url": "miapp://pago/cancelado",
      "webhook_url": "https://miapi.com/spidi/webhook"
    }
  ]
}
```

# 4. Tabla de Parámetros del Request

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>spidi_id</i></b></td><td><b><i>string (UUID)</i></b></td><td>✔ Sí</td><td>Identificador del comercio en SPIDI (validado contra las credenciales del request).</td></tr>
<tr><td><b><i>continue_on_error</i></b></td><td><b><i>boolean</i></b></td><td>✔ Sí</td><td>Define si se continúa con el resto de las creaciones cuando alguna falle. Default: `false`</td></tr>
<tr><td><b><i>items</i></b></td><td><b><i>[object]</i></b></td><td>✔ Sí</td><td>Listado de objeto, al menos 1 ítem es necesario</td></tr>
</table>

# 4.1 Subtabla: items

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>internal_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Referencia interna única del pagador.</td></tr>
<tr><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Moneda referencia que se usa como base para calcular el monto real en bolívares. Opciones: `"USD"`, `"EUR"`, `"COP"`. Si el monto en bolívares es fijo y no se desea indexar, se debe poner `"VES".`</td></tr>
<tr><td><b><i>amount</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Monto total en la moneda indicada por currency_reference (2 decimales).</td></tr>
<tr><td><b><i>identifier_label</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Título del identificador (ej.: "Nombre y apellido", "Número de orden", "Código de cliente". Visible para el pagador. **Nota:** Si no se especifica, se usará el identificador que usa el producto miSPIDI del usuario.</td></tr>
<tr><td><b><i>identifier</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Valor del identificador (p. ej., "María González", "FCT-2025-0342"). Visible para el pagador para mostrar información clara al cliente final en la pantalla de pago.</td></tr>
<tr><td><b><i>description</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Concepto, nota o descripción del pago. Visible para el pagador.</td></tr>
<tr><td><b><i>due_date_link</i></b></td><td><b><i>string (ISO 8601)</i></b></td><td>❌ No</td><td>Fecha y hora límite (Venezuela) de vencimiento. Si se alcanza, el enlace se comportará como se elija en campo: **expire_behavior_link**</td></tr>
<tr><td><b><i>expire_behavior_link</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Define qué le ocurre al enlace al vencer el due_date_link. Valores posibles: **"expire"**: el enlace queda expirado. Si hay una parada asociada, se debe generar un nuevo enlace y asociar a la parada. "**keep_active**": el enlace sigue vigente, pero se muestra una advertencia. Esto es ideal cuando no hay penalización en costo, pero sí en servicio.</td></tr>
<tr><td><b><i>late_notice_message</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Si posterior a la fecha de vencimiento el enlace sigue activo (keep_active), se mostrará el mensaje al pagador que se defina en este campo. Ejemplo: "Tu servicio está inactivo. Realiza el pago ahora para recuperar la continuidad de tu suscripción.",</td></tr>
<tr><td><b><i>success_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>URL o deeplink a la que SPIDI redirige si el pago es exitoso.</td></tr>
<tr><td><b><i>failure_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>URL o deeplink a la que SPIDI redirige si el pago falla o es cancelado.</td></tr>
<tr><td><b><i>webhook_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>URL donde SPIDI notificará cambios de estado vía webhook (HTTPS recomendado).</td></tr>
</table>

# 5. Ejemplo de Response 200

```json
{
  "success": true,
  "message": "Batch processed: 2 items created.",
  "batch_id": "batch_3a1d2e5c-9b77-4e21-8940-92b30b96f0a9",
  "results": [
    {
      "internal_reference": "INV-2025-10-USER_0001",
      "success": true,
      "data": {
        "session_id": "21f43a2b-d9ff-42d2-87ce-559bdaf1f901",
        "payment_url": "https://pay.spidi.com/21f43a2b-d9ff-42d2-87ce-559bdaf1f901",
        "status": "pending",
        "amount": 15.50,
        "currency_reference": "USD",
        "amount_ves": 1900.00,
        "bcv_exchange_rate": 122.58,
        "exchange_rate_from": "USD",
        "exchange_rate_to": "VES",
        "identifier_label": "Suscriptor",
        "identifier": "Ana Pérez",
        "description": "Suscripción Premium — Octubre",
        "due_date_link": "2025-10-31T23:59:59Z",
        "expire_behavior_link": "keep_active",
        "late_notice_message": "Tu servicio está inactivo. Paga para reactivar.",
        "success_url": "miapp://pago/exitoso",
        "failure_url": "miapp://pago/cancelado",
        "webhook_url": "https://miapi.com/spidi/webhook",
        "created_at": "2025-10-02T15:00:11Z"
      }
    },
    {
      "internal_reference": "INV-2025-10-USER_0002",
      "success": true,
      "data": {
        "session_id": "ea1db23f-5932-49a5-a96d-08bfb14c9c34",
        "payment_url": "https://pay.spidi.com/ea1db23f-5932-49a5-a96d-08bfb14c9c34",
        "status": "pending",
        "amount": 12.00,
        "currency_reference": "USD",
        "amount_ves": 1470.00,
        "bcv_exchange_rate": 122.50,
        "exchange_rate_from": "USD",
        "exchange_rate_to": "VES",
        "identifier_label": "Suscriptor",
        "identifier": "Luis Gómez",
        "description": "Suscripción Básica — Octubre",
        "due_date_link": "2025-10-31T23:59:59Z",
        "expire_behavior_link": "expire",
        "late_notice_message": null,
        "success_url": "miapp://pago/exitoso",
        "failure_url": "miapp://pago/cancelado",
        "webhook_url": "https://miapi.com/spidi/webhook",
        "created_at": "2025-10-02T15:00:11Z"
      }
    }
  ]
}
```

# 6. Tabla de Response 200

### Campos del Nivel Principal

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>success</i></b></td><td><b><i>boolean</i></b></td><td>✔ Sí</td><td>True si el endpoint se procesó de forma exitosa. False de lo contrario.</td></tr>
<tr><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Mensaje de confirmación legible para humanos.</td></tr>
<tr><td><b><i>batch_id</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Identificador único del batch, útil para auditoría y reintentos idempotentes.</td></tr>
<tr><td><b><i>results</i></b></td><td><b><i>[object]</i></b></td><td>✔ Sí</td><td>Array con la información de cada sesión creada.</td></tr>
</table>

### 6.1 Subtabla: results

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>internal_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco del valor enviado por el cliente para identificar el ítem.</td></tr>
<tr><td><b><i>success</i></b></td><td><b><i>boolean</i></b></td><td>✔ Sí</td><td>Resultado específico del ítem.</td></tr>
<tr><td><b><i>data</i></b></td><td><b><i>object</i></b></td><td>❌ No</td><td>Presente solo si success = true. Contiene los datos de la sesión creada.</td></tr>
<tr><td><b><i>errors</i></b></td><td><b><i>object</i></b></td><td>❌ No</td><td>Presente solo si success = false. Detalla validaciones fallidas por campo.</td></tr>
</table>

### 6.2 Subtabla: results.data

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>session_id</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Identificador único de la sesión de pago creada.</td></tr>
<tr><td><b><i>payment_url</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>URL donde el usuario puede ser redirigido para realizar el pago.</td></tr>
<tr><td><b><i>status</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Estado inicial de la sesión (siempre "pending").</td></tr>
<tr><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco del request.</td></tr>
<tr><td><b><i>amount</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Eco del request.</td></tr>
<tr><td><b><i>amount_ves</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Monto calculado en bolívares al momento de la creación de la sesión de pago.</td></tr>
<tr><td><b><i>bcv_exchange_rate</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Tasa oficial usada para la conversión a bolívares.</td></tr>
<tr><td><b><i>exchange_rate_from</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Moneda base de la tasa (p. ej., "USD").</td></tr>
<tr><td><b><i>exchange_rate_to</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Moneda destino de la tasa (siempre "VES").</td></tr>
<tr><td><b><i>identifier_label</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Eco del request.</td></tr>
<tr><td><b><i>identifier</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco del request.</td></tr>
<tr><td><b><i>description</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request.</td></tr>
<tr><td><b><i>due_date_link</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Fecha/hora de vencimiento informativa.</td></tr>
<tr><td><b><i>expire_behavior_link</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>keep_active o expire.</td></tr>
<tr><td><b><i>late_notice_message</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Mensaje mostrado si keep_active.</td></tr>
<tr><td><b><i>success_url</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request.</td></tr>
<tr><td><b><i>failure_url</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request.</td></tr>
<tr><td><b><i>webhook_url</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request.</td></tr>
<tr><td><b><i>created_at</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Timestamp de creación de la sesión en formato ISO 8601.</td></tr>
</table>

# 7. Ejemplos de Response ≠ 200

### Error 400 - Bad Request
```json
{
  "success": false,
  "message": "Missing required field: amount",
  "errors": {
    "amount": "This field is required."
  }
}
```

### Error 401/403 - Unauthorized/Forbidden
```json
{
  "success": false,
  "message": "Unauthorized.",
  "errors": {
    "spidi_id": "The credentials are incorrect"
  }
}
```

### Error 409 - Conflict (Idempotency)
```json
{
  "success": false,
  "message": "Conflict: duplicated request.",
  "errors": {
    "Idempotency-Key": "A session already exists for this key."
  }
}
```

### Error 422 - Unprocessable Entity
```json
{
  "success": false,
  "message": "Unprocessable entity.",
  "errors": {
    "currency_reference": "Allowed values are: 'VES', 'USD'.",
    "amount": "Must be a number > 0 with two decimals."
  }
}
```

### Error 500 - Internal Server Error
```json
{
  "success": false,
  "message": "Internal server error."
}
```

# 8. Tabla de Errores

## 8.1 Campos de nivel raíz (errores 4xx/5xx)

<table>
<tr><th>Campo</th><th>Tipo dato</th><th>Descripción</th></tr>
<tr><td><b><i>success</i></b></td><td><b><i>boolean</i></b></td><td>Siempre false en caso de error.</td></tr>
<tr><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>Resumen legible del error principal.</td></tr>
<tr><td><b><i>errors</i></b></td><td><b><i>objeto | null</i></b></td><td>Detalle por campo (opcional).</td></tr>
</table>

## 8.2 Subtabla: errors (cuando exista)

<table>
<tr><th>Código de error (HTTP)</th><th>Clave (campo)</th><th>Tipo dato</th><th>Descripción</th></tr>
<tr><td>400 Bad Request</td><td><b><i>amount</i></b></td><td><b><i>string</i></b></td><td>Error de validación en el monto (faltante, no numérico, ≤ 0).</td></tr>
<tr><td>400 Bad Request</td><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>Valor inválido (solo "VES" | "USD" según política actual).</td></tr>
<tr><td>400 Bad Request</td><td><b><i>spidi_id</i></b></td><td><b><i>string</i></b></td><td>Faltante, UUID inválido o no coincide con las credenciales del comercio.</td></tr>
<tr><td>400 Bad Request</td><td><b><i>success_url</i></b></td><td><b><i>string</i></b></td><td>URL malformada (si se envió).</td></tr>
<tr><td>400 Bad Request</td><td><b><i>failure_url</i></b></td><td><b><i>string</i></b></td><td>URL malformada (si se envió).</td></tr>
<tr><td>400 Bad Request</td><td><b><i>webhook_url</i></b></td><td><b><i>string</i></b></td><td>URL malformada (si se envió).</td></tr>
<tr><td>401 Unauthorized</td><td><b><i>spidi_id</i></b></td><td><b><i>string</i></b></td><td>El comercio no coincide con las credenciales proporcionadas.</td></tr>
<tr><td>403 Forbidden</td><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>No tienes permisos para esta operación.</td></tr>
<tr><td>409 Conflict</td><td><b><i>Idempotency-Key</i></b></td><td><b><i>string</i></b></td><td>Ya existe una sesión para esta clave.</td></tr>
<tr><td>422 Unprocessable Entity</td><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>Valores permitidos son: 'VES', 'USD'.</td></tr>
<tr><td>422 Unprocessable Entity</td><td><b><i>amount</i></b></td><td><b><i>string</i></b></td><td>Debe ser un número > 0 con dos decimales.</td></tr>
<tr><td>500 Internal Server Error</td><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>Error interno del servidor.</td></tr>
</table>
