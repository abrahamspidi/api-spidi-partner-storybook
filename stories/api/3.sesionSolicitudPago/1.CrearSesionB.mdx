import { Meta } from '@storybook/blocks';

<Meta title="API/Sesion Solicitud de Pago/1. Crear Sesion S" />
## Es clave haber leído la documentación de botones de pago antes de usar este endpoint.

**1\. Crear sesión de pago (botón de pago)**

Este endpoint permite crear una sesión de pago que puede ser utilizada desde un botón de pago en tu sitio web o aplicación móvil. Funciona independientemente de la estrategia de integración que elijas: redirección, deeplink o detección manual desde el cliente.

## **2\. Endpoint**

POST `{{base_url}}/api/v1/payment-session/button`

### **Ejemplo del Request (JSON)**

```json
{
  "currency_reference": "USD",
  "amount": 50.00,
  "identifier_label": "Nombre del cliente",
  "identifier": "Juan Pérez",
  "description": "Pago de servicio de internet",
  "success_url": "miapp://pago/exitoso",
  "failure_url": "miapp://pago/fallido",
  "webhook_url": "https://miapi.com/spidi/webhook"
}
```

## **3\. Tabla explicación de cada campo del Request**

<table>
<thead>
<tr>
<th>Campo</th>
<th>Tipo dato</th>
<th>Requerido</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>spidi_id</strong></td>
<td><strong>string</strong></td>
<td>✅ Sí</td>
<td>Identificador único de tu cuenta en SPIDI.</td>
</tr>
<tr>
<td><strong>currency_reference</strong></td>
<td><strong>string</strong></td>
<td>✅ Sí</td>
<td>Moneda referencia que se usa como base para calcular el monto real en bolívares. Opciones: <code>"USD"</code>, <code>"EUR"</code>, <code>"COP"</code>. Si el monto en bolívares es fijo y no se desea indexar, se debe poner <code>"VES"</code>. El pago <strong>siempre</strong> se realiza en VES, independientemente del valor de <code>currency_reference</code>.</td>
</tr>
<tr>
<td><strong>amount</strong></td>
<td><strong>number</strong></td>
<td>✅ Sí</td>
<td>Monto total en la moneda indicada por currency_reference (2 decimales).</td>
</tr>
<tr>
<td><strong>identifier_label</strong></td>
<td><strong>string</strong></td>
<td>❌ Opcional</td>
<td>Título del identificador (ej.: "Nombre y apellido", "Número de orden", "Código de cliente", <strong>Nota:</strong> Si no se especifica, se usará el identificador que usa el producto miSPIDI del usuario.</td>
</tr>
<tr>
<td><strong>identifier</strong></td>
<td><strong>string</strong></td>
<td>✅ Sí</td>
<td>Valor del identificador (ej. "Juan Pérez", "FCT-2025-0342"). A pesar de estar visible para el pagador, este identificador puede usarse para trazabilidad interna. Código de tu sistema propio.</td>
</tr>
<tr>
<td><strong>description</strong></td>
<td><strong>string</strong></td>
<td>❌ Opcional</td>
<td>Concepto, nota o descripción del pago.</td>
</tr>
<tr>
<td><strong>success_url</strong></td>
<td><strong>string (URL)</strong></td>
<td>❌ Opcional</td>
<td>URL o deeplink a la que SPIDI redirige si el pago es exitoso.</td>
</tr>
<tr>
<td><strong>failure_url</strong></td>
<td><strong>string (URL)</strong></td>
<td>❌ Opcional</td>
<td>URL o deeplink a la que SPIDI redirige si el pago falla o es cancelado.</td>
</tr>
<tr>
<td><strong>webhook_url</strong></td>
<td><strong>string (URL)</strong></td>
<td>❌ Opcional</td>
<td>URL donde SPIDI notificará cambios de estado vía webhook (HTTPS recomendado).</td>
</tr>
</tbody>
</table>

## **4\. Ejemplo de Response 200**

```json
{
  "success": true,
  "message": "Payment session created successfully.",
  "data": {
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "payment_url": "{url}/?id=3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "currency_reference": "USD",
    "amount": 50.00,
    "amount_ves": 6100.00,
    "amount_usd": 50.00,
    "bcv_exchange_rate": 122.03,
    "exchange_rate_from": "USD",
    "exchange_rate_to": "VES",
    "identifier_label": "Nombre del cliente",
    "identifier": "Juan Pérez",
    "description": "Pago de membresía",
    "success_url": "https://miapp.com/pago-exitoso",
    "failure_url": "https://miapp.com/pago-fallido",
    "webhook_url": "https://miapi.com/spidi/webhook"
  }
}
```

### **5\. Tablas explicación de cada campo del Response 200**

### **5.1 Campos de nivel raíz (Response 200\)**

<table>
<thead>
<tr>
<th>Campo</th>
<th>Tipo dato</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>success</strong></td>
<td><strong>Boolean</strong></td>
<td><strong>Generado.</strong> True si el endpoint se proceso de forma exitosa. False de lo contrario.</td>
</tr>
<tr>
<td><strong>message</strong></td>
<td><strong>String</strong></td>
<td><strong>Generado.</strong> Mensaje de confirmación legible para humanos.</td>
</tr>
<tr>
<td><strong>data</strong></td>
<td><strong>Objeto</strong></td>
<td><strong>Generado.</strong> Objeto con la información de la sesión creada.</td>
</tr>
</tbody>
</table>

### **5.2 Subtabla: Response 200 → data** 

<table>
<thead>
<tr>
<th>data.x</th>
<th>Tipo dato</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>session_id</strong></td>
<td><strong>string</strong></td>
<td><strong>Generado.</strong> Identificador único de la sesión de pago creada.</td>
</tr>
<tr>
<td><strong>payment_url</strong></td>
<td><strong>string</strong></td>
<td><strong>Generado.</strong> Link "URL" donde el usuario debe ser redirigido para realizar el pago.</td>
</tr>
<tr>
<td><strong>currency_reference</strong></td>
<td><strong>string</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
<tr>
<td><strong>amount</strong></td>
<td><strong>number</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
<tr>
<td><strong>amount_ves</strong></td>
<td><strong>number</strong></td>
<td><strong>Generado.</strong> Monto calculado en bolívares al momento de la creación de la sesión de pago.</td>
</tr>
<tr>
<td><strong>amount_usd</strong></td>
<td><strong>number</strong></td>
<td>En desuso. Monto calculado en dólares, de manera referencial. Si la divisa original es en USD, este campo será idéntico al campo de amount</td>
</tr>
<tr>
<td><strong>bcv_exchange_rate</strong></td>
<td><strong>number</strong></td>
<td><strong>Generado.</strong> Tasa oficial usada para la conversión a bolívares. Si <strong>currency_reference</strong> es "VES", devolverá "USD".</td>
</tr>
<tr>
<td><strong>exchange_rate_from</strong></td>
<td><strong>string</strong></td>
<td><strong>Generado.</strong> Moneda base de la tasa de cambio utilizada. Si <strong>currency_reference</strong> es "VES", devolverá "USD"</td>
</tr>
<tr>
<td><strong>exchange_rate_to</strong></td>
<td><strong>string</strong></td>
<td><strong>Generado.</strong> Moneda destino de la tasa de cambio utilizada (siempre "VES")</td>
</tr>
<tr>
<td><strong>identifier_label</strong></td>
<td><strong>string</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
<tr>
<td><strong>identifier</strong></td>
<td><strong>string</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
<tr>
<td><strong>description</strong></td>
<td><strong>string/ null</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
<tr>
<td><strong>success_url</strong></td>
<td><strong>string/ null</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
<tr>
<td><strong>failure_url</strong></td>
<td><strong>string/ null</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
<tr>
<td><strong>webhook_url</strong></td>
<td><strong>string/ null</strong></td>
<td><strong>Eco request.</strong></td>
</tr>
</tbody>
</table>

## **6\. Ejemplos de Responses diferentes de 200**

### **6.1 400 Bad Request (campo faltante)**

```json
{
  "success": false,
  "message": "Missing required field: amount",
  "errors": {
    "amount": "This field is required."
  }
}
```

### **6.2 401/403 Unauthorized (credenciales/propiedad)**

```json
{
  "success": false,
  "message": "Unauthorized.",
  "errors": {
    "spidi_id": "The merchant does not match the provided credentials."
  }
}
```

### **6.3 409 Conflict (idempotencia)**

```json
{
  "success": false,
  "message": "Conflict: duplicated request.",
  "errors": {
    "Idempotency-Key": "A session already exists for this key."
  }
}
```

### **6.4 422 Unprocessable Entity (tipos/valores inválidos)**

```json
{
  "success": false,
  "message": "Unprocessable entity.",
  "errors": {
    "currency_reference": "Allowed values are: 'VES', 'USD'.",
    "amount": "Must be a number > 0 with two decimals."
  }
}
```

### **6.5 500 Internal Server Error**

```json
{
  "success": false,
  "message": "Internal server error."
}
```

## **7\. Tabla de explicación de cada campo de los distintos Response (errores)**

### **7.1 Campos de nivel raíz (errores 4xx/5xx)**

<table>
<thead>
<tr>
<th>Campo</th>
<th>Tipo dato</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>success</strong></td>
<td><strong>boolean</strong></td>
<td>Siempre false en caso de error.</td>
</tr>
<tr>
<td><strong>message</strong></td>
<td><strong>string</strong></td>
<td>Resumen legible del error principal.</td>
</tr>
<tr>
<td><strong>errors</strong></td>
<td><strong>objeto | null</strong></td>
<td>Detalle por campo (opcional).</td>
</tr>
</tbody>
</table>

### **7.2 Subtabla: errors (cuando exista)**

<table>
<thead>
<tr>
<th>Código de error (HTTP)</th>
<th>Clave (campo)</th>
<th>Tipo dato</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>400 Bad Request</strong></td>
<td><strong>amount</strong></td>
<td><strong>string</strong></td>
<td>Error de validación en el monto (faltante, no numérico, ≤ 0).</td>
</tr>
<tr>
<td><strong>400 Bad Request</strong></td>
<td><strong>currency_reference</strong></td>
<td><strong>string</strong></td>
<td>Valor inválido (solo "VES" | "USD" según política actual).</td>
</tr>
<tr>
<td><strong>400 Bad Request</strong></td>
<td><strong>spidi_id</strong></td>
<td><strong>string</strong></td>
<td>Faltante, UUID inválido o no coincide con las credenciales del comercio.</td>
</tr>
<tr>
<td><strong>400 Bad Request</strong></td>
<td><strong>success_url</strong></td>
<td><strong>string</strong></td>
<td>URL malformada (si se envió).</td>
</tr>
<tr>
<td><strong>400 Bad Request</strong></td>
<td><strong>failure_url</strong></td>
<td><strong>string</strong></td>
<td>URL malformada (si se envió).</td>
</tr>
<tr>
<td><strong>400 Bad Request</strong></td>
<td><strong>webhook_url</strong></td>
<td><strong>string</strong></td>
<td>URL malformada (si se envió).</td>
</tr>
<tr>
<td><strong>401/403</strong></td>
<td><strong>spidi_id</strong></td>
<td><strong>string</strong></td>
<td>No pertenece</td>
</tr>
<tr>
<td><strong>409</strong></td>
<td><strong>Idempotency-Key</strong></td>
<td><strong>string</strong></td>
<td>Conflicto: ya existe una sesión para esa clave (409).</td>
</tr>
<tr>
<td><strong>422 Unprocessable Entity</strong></td>
<td><strong>-</strong></td>
<td></td>
<td>Estructura del JSON incorrecta (por ejemplo, comas faltantes, tipos de datos mal usados).</td>
</tr>
<tr>
<td><strong>500 Internal Server Error</strong></td>
<td><strong>-</strong></td>
<td></td>
<td>Fallo interno inesperado. Intenta más tarde</td>
</tr>
</tbody>
</table>
