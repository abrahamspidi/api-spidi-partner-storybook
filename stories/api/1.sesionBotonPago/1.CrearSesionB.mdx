import { Meta } from '@storybook/blocks';

<Meta title="API/Sesion Boton de Pago/1. Crear Sesion B" />

## Crear Sesion de Boton de Pago
# 1. Descripción

Permite crear una sesión de pago para ser utilizada desde un botón de pago en tu sitio web o aplicación móvil. Funciona con cualquier estrategia de integración: redirección, deeplink o detección manual desde el cliente.

Es clave haber leído la documentación de botones de pago antes de usar este endpoint.

# 2. Endpoint
Method: **POST**
```
{{baseUrl}}/api/v1/payment-session/button
```

**Headers requeridos:**
- `Authorization: Bearer {token}`
- `Content-Type: application/json`
- `Idempotency-Key: {unique_key}`

# 3. Ejemplo del Request

## 3.1 Crear payment-session con agreement SESSION (porcentajes, 2 receptores)

```json
{
  "currency_reference": "USD",
  "amount_reference": 50.00,
  "agreement_id": "stl_session_01",
  "identifier_label": "Nombre del cliente",
  "identifier": "Juan Pérez",
  "description": "Pago de servicio de internet",
  "success_url": "miapp://pago/exitoso",
  "failure_url": "miapp://pago/fallido",
  "webhook_url": "https://miapi.com/spidi/webhook",
  "split": { 
    "type": "percent",
    "rules": [
      { "recipient_id": "owner", "percent": 60.0, "label": "Comercio" },
      { "recipient_id": "uuid_partner1", "percent": 40.0, "label": "Partner" }
    ]
  }
}
```

## 3.2 Crear payment-session con agreement SESSION (absolutos, 2 receptores)

```json
{
  "currency_reference": "USD",
  "amount_reference": 250.00,
  "agreement_id": "stl_session_01",
  "identifier_label": "Nombre del cliente",
  "identifier": "Juan Pérez",
  "description": "Pago de servicio de internet",
  "success_url": "miapp://pago/exitoso",
  "failure_url": "miapp://pago/fallido",
  "webhook_url": "https://miapi.com/spidi/webhook",
  "split": { 
    "type": "absolute",
    "rules": [
      { "recipient_id": "owner", "amount_reference": 200.00, "label": "Comercio" },
      { "recipient_id": "uuid_partner2", "amount_reference": 50.00, "label": "Fijo partner" }
    ]
  }
}
```

# 4. Tabla de Parámetros del Request

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>agreement_id</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Identificador único de tu cuenta en SPIDI.</td></tr>
<tr><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Moneda referencia base para calcular a bolívares. Opciones: `"USD"`, `"EUR"`, `"COP"`. Para monto fijo en VES, usar `"VES"`. El pago siempre se liquida en VES.</td></tr>
<tr><td><b><i>amount_reference</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Monto total en la moneda indicada por `currency_reference` (2 decimales).</td></tr>
<tr><td><b><i>identifier_label</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Título del identificador (ej.: "Nombre y apellido", "Número de orden"). Si no se especifica, se usará el identificador configurado en miSPIDI.</td></tr>
<tr><td><b><i>identifier</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Valor del identificador (ej.: "Juan Pérez", "FCT-2025-0342"). Útil para trazabilidad interna.</td></tr>
<tr><td><b><i>description</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Concepto o nota del pago.</td></tr>
<tr><td><b><i>success_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>URL/deeplink al que se redirige si el pago es exitoso.</td></tr>
<tr><td><b><i>failure_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>URL/deeplink al que se redirige si el pago falla o es cancelado.</td></tr>
<tr><td><b><i>webhook_url</i></b></td><td><b><i>string (URL)</i></b></td><td>❌ No</td><td>URL donde SPIDI notificará cambios de estado vía webhook (HTTPS recomendado).</td></tr>
</table>

# 5. Ejemplo de Response 200

```json
{
  "success": true,
  "message": "Payment session created successfully.",
  "data": {
    "session_origin": "button",
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "payment_url": "{url}/?id=3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "currency_reference": "USD",
    "amount_reference": 50.00,
    "identifier_label": "Nombre del cliente",
    "identifier": "Juan Pérez",
    "description": "Pago de membresía",
    "success_url": "https://miapp.com/pago-exitoso",
    "failure_url": "https://miapp.com/pago-fallido",
    "webhook_url": "https://miapi.com/spidi/webhook",
    "created_at": "2025-09-18T20:45:00Z"
  }
}
```

# 6. Tabla de Response 200

### Campos del Nivel Principal

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>success</i></b></td><td><b><i>boolean</i></b></td><td>✔ Sí</td><td>Indica si la operación fue exitosa</td></tr>
<tr><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Mensaje de confirmación</td></tr>
<tr><td><b><i>data</i></b></td><td><b><i>object</i></b></td><td>✔ Sí</td><td>Datos de la sesión creada</td></tr>
</table>

### 6.1 Subtabla: data

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>session_id</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Identificador único de la sesión</td></tr>
<tr><td><b><i>payment_url</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>URL donde el usuario realiza el pago</td></tr>
<tr><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco del request</td></tr>
<tr><td><b><i>amount</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Eco del request</td></tr>
<tr><td><b><i>amount_ves</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Monto calculado en VES al crear la sesión</td></tr>
<tr><td><b><i>amount_usd</i></b></td><td><b><i>number</i></b></td><td>❌ No</td><td>En desuso. Referencial</td></tr>
<tr><td><b><i>bcv_exchange_rate</i></b></td><td><b><i>number</i></b></td><td>✔ Sí</td><td>Tasa oficial usada para la conversión. Si `currency_reference` es `VES`, devolverá `USD`.</td></tr>
<tr><td><b><i>exchange_rate_from</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Moneda base de la tasa. Si `currency_reference` es `VES`, devolverá `USD`.</td></tr>
<tr><td><b><i>exchange_rate_to</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Moneda destino (siempre `VES`).</td></tr>
<tr><td><b><i>identifier_label</i></b></td><td><b><i>string</i></b></td><td>❌ No</td><td>Eco del request</td></tr>
<tr><td><b><i>identifier</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Eco del request</td></tr>
<tr><td><b><i>description</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request</td></tr>
<tr><td><b><i>success_url</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request</td></tr>
<tr><td><b><i>failure_url</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request</td></tr>
<tr><td><b><i>webhook_url</i></b></td><td><b><i>string|null</i></b></td><td>❌ No</td><td>Eco del request</td></tr>
<tr><td><b><i>created_at</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Fecha y hora de creación de la sesión de pago (ISO 8601).</td></tr>
</table>

# 7. Ejemplos de Response ≠ 200

### Error 400 - Bad Request
```json
{
  "success": false,
  "message": "Missing required field: amount",
  "errors": {
    "amount": "This field is required."
  }
}
```

### Error 401/403 - Unauthorized/Forbidden
```json
{
  "success": false,
  "message": "Unauthorized.",
  "errors": {
    "spidi_id": "The merchant does not match the provided credentials."
  }
}
```

### Error 409 - Conflict (Idempotency)
```json
{
  "success": false,
  "message": "Conflict: duplicated request.",
  "errors": {
    "Idempotency-Key": "A session already exists for this key."
  }
}
```

### Error 422 - Unprocessable Entity
```json
{
  "success": false,
  "message": "Unprocessable entity.",
  "errors": {
    "currency_reference": "Allowed values are: 'VES', 'USD'.",
    "amount": "Must be a number > 0 with two decimals."
  }
}
```

### Error 500 - Internal Server Error
```json
{
  "success": false,
  "message": "Internal server error."
}
```

# 8. Tabla de explicación de cada campo de los distintos Response (errores)

## 8.1 Campos de nivel raíz (errores 4xx/5xx)

<table>
<tr><th>Campo</th><th>Tipo dato</th><th>Descripción</th></tr>
<tr><td><b><i>success</i></b></td><td><b><i>boolean</i></b></td><td>Siempre false en caso de error.</td></tr>
<tr><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>Resumen legible del error principal.</td></tr>
<tr><td><b><i>errors</i></b></td><td><b><i>objeto | null</i></b></td><td>Detalle por campo (opcional).</td></tr>
</table>

## 8.2 Subtabla: errors (cuando exista)

<table>
<tr><th>Código de error (HTTP)</th><th>Clave (campo)</th><th>Tipo dato</th><th>Descripción</th></tr>
<tr><td>400 Bad Request</td><td><b><i>amount</i></b></td><td><b><i>string</i></b></td><td>Error de validación en el monto (faltante, no numérico, ≤ 0).</td></tr>
<tr><td>400 Bad Request</td><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>Valor inválido (solo "VES" | "USD" según política actual).</td></tr>
<tr><td>400 Bad Request</td><td><b><i>spidi_id</i></b></td><td><b><i>string</i></b></td><td>Faltante, UUID inválido o no coincide con las credenciales del comercio.</td></tr>
<tr><td>400 Bad Request</td><td><b><i>success_url</i></b></td><td><b><i>string</i></b></td><td>URL malformada (si se envió).</td></tr>
<tr><td>400 Bad Request</td><td><b><i>failure_url</i></b></td><td><b><i>string</i></b></td><td>URL malformada (si se envió).</td></tr>
<tr><td>401 Unauthorized</td><td><b><i>spidi_id</i></b></td><td><b><i>string</i></b></td><td>El comercio no coincide con las credenciales proporcionadas.</td></tr>
<tr><td>403 Forbidden</td><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>No tienes permisos para esta operación.</td></tr>
<tr><td>409 Conflict</td><td><b><i>Idempotency-Key</i></b></td><td><b><i>string</i></b></td><td>Ya existe una sesión para esta clave.</td></tr>
<tr><td>422 Unprocessable Entity</td><td><b><i>currency_reference</i></b></td><td><b><i>string</i></b></td><td>Valores permitidos son: 'VES', 'USD'.</td></tr>
<tr><td>422 Unprocessable Entity</td><td><b><i>amount</i></b></td><td><b><i>string</i></b></td><td>Debe ser un número > 0 con dos decimales.</td></tr>
<tr><td>500 Internal Server Error</td><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>Error interno del servidor.</td></tr>
</table>
