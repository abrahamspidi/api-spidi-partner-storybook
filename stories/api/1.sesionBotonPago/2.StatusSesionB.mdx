import { Meta } from '@storybook/blocks';

<Meta title="API/Sesion Boton de Pago/2. Status Sesion B" />

# 1. Descripción

Este endpoint permite consultar el estado actual de una sesión de pago y sus datos esenciales, generada mediante el botón de pago, ya sea desde una aplicación web o móvil.

Este endpoint es la fuente oficial y confiable para verificar si la sesión de pago creada por la vía de botón de pago, fue completado con éxito (paid) rechazado o fallido (failed) o si expiró (expired).

Una sesión de pago puede crearse mediante un **Botón de pago** o una **Solicitud de pago**, cada una con su propio endpoint de creación. Sin embargo, para **consultar** una sesión de pago —sin importar cómo haya sido creada— se utiliza **el mismo endpoint** de consulta. En la respuesta (`response`), existe un campo "session_origin" que revelerá si fue creada por botón de pago o por solicitud. Por otro lado, el campo **`status`** puede tener un valor adicional: **`failed`**, en los casos donde la sesión fue creada a través de un **Botón de pago**. 

**Nota importante (botón vs solicitud):**

Tras paid, la liquidación al receptor puede tardar unos segundos; en ese caso receiver_details puede venir null temporalmente. Independientemente de si la liquidación al receptor aún no ha ocurrido, es indispensable notificar al pagador que su pago fue realizado exitosamente y continuar con la entrega del servicio o producto sin ningún problema. La liquidación al receptor es un proceso interno y, aunque puede demorar pocos segundos, o hasta 2 minutos, no existe riesgo de fallo. En esta etapa: el pago ya está confirmado, y se genera una cuenta por cobrar al usuario que constituye un derecho causado e irrevocable según los términos acordados.

Por lo tanto, en caso de que tengas control, no retengas ni retrases la prestación del servicio al pagador mientras esperas la liquidación.

Si necesitas mostrar o procesar datos de la liquidación, consulta el endpoint de status periódicamente hasta que los campos de receiver_details estén presentes. Opcionalmente, si implementaste un webhook, recibirás una notificación automática en tu API cuando la liquidación se haya completado y los datos estén disponibles. 

**NOTA 2:** Recuerda que se incluye el URL del comprobante exitoso, que debe ser mostrado al usuario de una forma u otra.

# 2. Endpoint

Method: **GET**
```
{{baseUrl}}/api/v1/payment-session/{session_id}/status
```

**Headers requeridos:**
- `Authorization: Bearer {token}`
- `Accept: application/json`

**Compatibilidad temporal versión vieja:**
```
{{baseUrl}}/api/v1/payment-session/status/{session_id}
```

# 3. Ejemplo del Request

```
GET {{baseUrl}}/api/v1/payment-session/3ddc4cfb-c09a-43de-92c1-e4a069732e90/status
```

# 4. Tabla de Parámetros del Request

### Campos del Nivel Principal

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>session_id</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>ID de la sesión de pago generada y recibida en el response del endpoint …/payment-session/button. Formato: ^[a-zA-Z0-9_-]+$</td></tr>
</table>

*(No hay body ni query params en este endpoint.)*

# 5. Ejemplo de Response 200

### status = `pending | paid | failed | expired`

### **5.1 Caso status = `pending`**

```json
{
  "success": true,
  "message": "Successful query.",
  "data": {
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "session_origin": "button",
    "source_channel": "API",
    "status": "pending",
    "user_message": "Esperando que completes el pago",
    "due_date_link": "2025-10-31T23:59:59Z",
    "expire_behavior_link": "expire",
    "late_notice_message": null,
    "session_details": {
      "spidi_transaction_id": null,
      "spidi_transaction_url": null,
      "currency_reference": "USD",
      "amount": 50.00,
      "amount_ves": 6100.00,
      "bcv_exchange_rate": 122.0,
      "exchange_rate_from": "USD",
      "exchange_rate_to": "VES",
      "payer_details": {
        "identifier_label": "Nombre y Apellido",
        "identifier": "Federico Coppola",
        "action_date": null,
        "bank_name": null,
        "bank_reference_id": null,
        "description": "",
        "crypto_details": null
      },
      "receiver_details": null
    }
  }
}
```

### **4.2 Caso status = `paid` (liquidación en tránsito: `receiver_details` vacío)**

```json
{
  "success": true,
  "message": "Successful query.",
  "data": {
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "session_origin": "button",
    "status": "paid",
    "user_message": "Operación realizada exitosamente",
    "session_details": {
      "spidi_transaction_id": 643,
      "spidi_transaction_url": "https://pay.spidi.com/receipt/643",
      "currency_reference": "USD",
      "amount": 50.00,
      "amount_ves": 6100.00,
      "bcv_exchange_rate": 122.0,
      "exchange_rate_from": "USD",
      "exchange_rate_to": "VES",
      "payer_details": {
        "identifier_label": "2025-07-25T12:11:13Z",
        "identifier": "2025-07-25T12:11:13Z",
        "action_date": "2025-07-25T12:11:13Z",
        "bank_name": "BANCO MERCANTIL",
        "bank_reference_id": "00001440",
        "description": "Pago de membresía",
        "crypto_details": null
      },
      "receiver_details": null
    }
  }
}
```

### **4.3 Caso status = `paid` (liquidación completada)**

```json
{
  "success": true,
  "message": "Successful query.",
  "data": {
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "session_origin": "button",
    "status": "paid",
    "user_message": "Operación realizada exitosamente",
    "session_details": {
      "spidi_transaction_id": 643,
      "spidi_transaction_url": "https://pay.spidi.com/receipt/643",
      "amount": 50.00,
      "currency_reference": "USD",
      "amount_ves": 6100.00,
      "bcv_exchange_rate": 122.0,
      "exchange_rate_from": "USD",
      "exchange_rate_to": "VES",
      "payer_details": {
        "identifier_label": "2025-07-25T12:11:13Z",
        "identifier": "2025-07-25T12:11:13Z",
        "action_date": "2025-07-25T12:11:13Z",
        "bank_name": "BANCO MERCANTIL",
        "bank_reference_id": "00001440",
        "description": "Pago de membresía",
        "crypto_details": null
      },
      "receiver_details": {
        "spidi_credit_id": 168,
        "received_date": "2025-07-25T12:12:07Z",
        "bank_name": "BANESCO",
        "bank_reference_id": "00107273",
        "amount_ves_received": 6050.00,
        "bank_commission_ves": 50.00
      }
    }
  }
}
```

### **4.4 Caso status = `expired`**

```json
{
  "success": true,
  "message": "Successful query.",
  "data": {
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "session_origin": "button",
    "status": "expired",
    "user_message": "La sesión expiró por inactividad. Intenta nuevamente.",
    "session_details": {
      "spidi_transaction_id": null,
      "spidi_transaction_url": null,
      "payer_details": {
        "action_date": "2025-07-25T14:55:02Z"
      },
      "receiver_details": null
    }
  }
}
```

### **4.5 Caso status = `failed`**

```json
{
  "success": true,
  "message": "Successful query.",
  "data": {
    "session_id": "3ddc4cfb-c09a-43de-92c1-e4a069732e90",
    "session_origin": "button",
    "status": "failed",
    "user_message": "No se pudo completar el pago",
    "session_details": {
      "spidi_transaction_id": 644,
      "spidi_transaction_url": "https://pay.spidi.com/receipt/644",
      "amount": 50.00,
      "currency_reference": "USD",
      "amount_ves": 6100.00,
      "bcv_exchange_rate": 122.0,
      "exchange_rate_from": "USD",
      "exchange_rate_to": "VES",
      "payer_details": {
        "identifier_label": "2025-07-25T12:11:13Z",
        "identifier": "2025-07-25T12:11:13Z",
        "action_date": "2025-07-25T12:11:13Z",
        "bank_name": "BANCO MERCANTIL",
        "bank_reference_id": "",
        "description": "Pago de membresía",
        "crypto_details": {}
      },
      "receiver_details": {}
    }
  }
}
```






























# 6. Tabla de Response 200

### Campos del Nivel Principal

<table>
<tr><th>Campo</th><th>Tipo</th><th>Requerido</th><th>Descripción</th></tr>
<tr><td><b><i>success</i></b></td><td><b><i>boolean</i></b></td><td>✔ Sí</td><td>True si el endpoint se procesó de forma exitosa. False de lo contrario.</td></tr>
<tr><td><b><i>message</i></b></td><td><b><i>string</i></b></td><td>✔ Sí</td><td>Mensaje de confirmación legible para humanos.</td></tr>
<tr><td><b><i>data</i></b></td><td><b><i>object</i></b></td><td>✔ Sí</td><td>Objeto con la información de la sesión consultada.</td></tr>
</table>

# 7. Ejemplos de Response ≠ 200

### 7.1 400 Bad Request (campo faltante)

```json
{
  "success": false,
  "message": "Missing required field: session_id",
  "errors": {
    "session_id": "This field is required."
  }
}
```

### 7.2 401/403 Unauthorized (credenciales/propiedad)

```json
{
  "success": false,
  "message": "Unauthorized.",
  "errors": {
    "spidi_id": "The credentials are incorrect"
  }
}
```

### 7.4 422 Unprocessable Entity (tipos/valores inválidos)

```json
{
  "success": false,
  "message": "Unprocessable entity.",
  "errors": {
    "session_id": "Invalid session ID format"
  }
}
```

### 7.5 500 Internal Server Error

```json
{
  "success": false,
  "message": "Internal server error."
}
```

# 8. Tabla de Errores

### Campos del Nivel Principal

<table>
<tr><th>Código HTTP</th><th>Código de Error</th><th>Descripción</th><th>Campos de Error</th></tr>
<tr><td>400</td><td><b><i>BAD_REQUEST</i></b></td><td>Datos de request inválidos</td><td><b><i>field</i></b>, <b><i>message</i></b></td></tr>
<tr><td>401</td><td><b><i>UNAUTHORIZED</i></b></td><td>Token de autenticación inválido</td><td><b><i>message</i></b></td></tr>
<tr><td>403</td><td><b><i>FORBIDDEN</i></b></td><td>No tienes permisos para esta operación</td><td><b><i>message</i></b></td></tr>
<tr><td>404</td><td><b><i>SESSION_NOT_FOUND</i></b></td><td>Sesión de pago no encontrada</td><td><b><i>message</i></b></td></tr>
<tr><td>409</td><td><b><i>CONFLICT</i></b></td><td>Conflicto de idempotencia</td><td><b><i>message</i></b></td></tr>
<tr><td>422</td><td><b><i>UNPROCESSABLE_ENTITY</i></b></td><td>Estructura del JSON incorrecta</td><td><b><i>message</i></b></td></tr>
<tr><td>429</td><td><b><i>RATE_LIMIT_EXCEEDED</i></b></td><td>Límite de requests excedido</td><td><b><i>message</i></b>, <b><i>retry_after</i></b></td></tr>
<tr><td>500</td><td><b><i>INTERNAL_SERVER_ERROR</i></b></td><td>Error interno del servidor</td><td><b><i>message</i></b></td></tr>
</table>



# **8) Notas y buenas prácticas**

* **Backend obligatorio para confirmar pagos:** No asumas `paid` solo por redirección; **consulta este endpoint** desde tu servidor antes de liberar servicios.

* **Liquidación diferida:** Tras `paid`, `receiver_details` puede estar vacío temporalmente. **No bloquees** la entrega al pagador; actualiza luego vía **webhook** (`payment.paid`/`payment.settled`) o reconsulta hasta completar datos de liquidación.

* **Estados vigentes:** `pending`, `paid`, `expired` y para botones de pago: `expired.`

